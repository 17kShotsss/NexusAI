<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nexus AI</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  /* Light theme (default) */
  --bg-primary: #ffffff;
  --bg-secondary: #f8f9fa;
  --bg-tertiary: #f1f3f4;
  --bg-sidebar: #ffffff;
  --text-primary: #2d333a;
  --text-secondary: #656b73;
  --text-muted: #8e9297;
  --border-light: #e5e7eb;
  --border-medium: #d1d5db;
  --accent-primary: #ff7c2a;
  --accent-hover: #e66a1f;
  --hover-bg: #f9fafb;
  --message-user-bg: #f0f0f0;
  --message-ai-bg: #ffffff;
  --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.1);
  --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.08);
}

body.dark {
  --bg-primary: #212121;
  --bg-secondary: #2f2f2f;
  --bg-tertiary: #1a1a1a;
  --bg-sidebar: #171717;
  --text-primary: #ececec;
  --text-secondary: #c4c4c4;
  --text-muted: #8b8b8b;
  --border-light: #404040;
  --border-medium: #525252;
  --accent-primary: #ff8c42;
  --accent-hover: #ff7c2a;
  --hover-bg: #2a2a2a;
  --message-user-bg: #2f2f2f;
  --message-ai-bg: #212121;
  --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.3);
  --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.2);
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  display: flex;
  height: 100vh;
  transition: all 0.2s ease;
}

/* Sidebar */
.sidebar {
  width: 280px;
  background: var(--bg-sidebar);
  border-right: 1px solid var(--border-light);
  display: flex;
  flex-direction: column;
  transition: all 0.2s ease;
}

.sidebar-header {
  padding: 16px;
  border-bottom: 1px solid var(--border-light);
}

.new-chat-btn {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-primary);
  border: 1px solid var(--border-medium);
  color: var(--text-primary);
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.new-chat-btn:hover {
  background: var(--hover-bg);
  border-color: var(--border-medium);
}

.new-chat-btn svg {
  width: 16px;
  height: 16px;
  stroke-width: 2;
}

.chat-history {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.chat-history::-webkit-scrollbar {
  width: 4px;
}

.chat-history::-webkit-scrollbar-track {
  background: transparent;
}

.chat-history::-webkit-scrollbar-thumb {
  background: var(--border-medium);
  border-radius: 2px;
}

.chat-item {
  padding: 12px 16px;
  margin: 2px 0;
  border-radius: 8px;
  cursor: pointer;
  color: var(--text-secondary);
  font-size: 14px;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
}

.chat-item:hover {
  background: var(--hover-bg);
  color: var(--text-primary);
}

.chat-item.active {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

.chat-item-content {
  flex: 1;
  overflow: hidden;
}

.chat-item-title {
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 2px;
}

.chat-item-date {
  font-size: 12px;
  color: var(--text-muted);
}

.delete-btn {
  opacity: 0;
  padding: 4px;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.15s ease;
}

.chat-item:hover .delete-btn {
  opacity: 1;
}

.delete-btn:hover {
  background: #fee;
  color: #dc2626;
}

.delete-btn svg {
  width: 16px;
  height: 16px;
}

.sidebar-footer {
  padding: 16px;
  border-top: 1px solid var(--border-light);
}

.footer-btn {
  width: 100%;
  padding: 12px 16px;
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  text-align: left;
  font-size: 14px;
  border-radius: 8px;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  gap: 12px;
}

.footer-btn:hover {
  background: var(--hover-bg);
  color: var(--text-primary);
}

.footer-btn svg {
  width: 16px;
  height: 16px;
}

/* Main content */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
}

.header {
  padding: 16px 24px;
  border-bottom: 1px solid var(--border-light);
  background: var(--bg-primary);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.header-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 12px;
}

.status-dot {
  width: 8px;
  height: 8px;
  background: #10b981;
  border-radius: 50%;
}

.header-actions {
  display: flex;
  gap: 8px;
}

.header-btn {
  padding: 8px;
  background: none;
  border: 1px solid var(--border-light);
  color: var(--text-secondary);
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.header-btn:hover {
  background: var(--hover-bg);
  border-color: var(--border-medium);
  color: var(--text-primary);
}

.header-btn svg {
  width: 16px;
  height: 16px;
}

/* Chat area */
.chat-container {
  flex: 1;
  overflow-y: auto;
  background: var(--bg-primary);
}

.chat-container::-webkit-scrollbar {
  width: 4px;
}

.chat-container::-webkit-scrollbar-track {
  background: transparent;
}

.chat-container::-webkit-scrollbar-thumb {
  background: var(--border-medium);
  border-radius: 2px;
}

.chat-inner {
  max-width: 768px;
  margin: 0 auto;
  padding: 24px;
}

.message {
  margin-bottom: 24px;
  display: flex;
  gap: 16px;
  position: relative;
}

.message.user {
  flex-direction: row-reverse;
}

.message.user .message-content {
  background: var(--message-user-bg);
}

.message.ai .message-content {
  background: var(--message-ai-bg);
}

.avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 600;
  flex-shrink: 0;
  margin-top: 4px;
}

.avatar.user {
  background: #6366f1;
  color: white;
}

.avatar.ai {
  background: var(--accent-primary);
  color: white;
}

.message-content {
  flex: 1;
  padding: 16px 20px;
  border-radius: 16px;
  border: 1px solid var(--border-light);
  font-size: 15px;
  line-height: 1.6;
  position: relative;
}

.message.user .message-content {
  border-radius: 16px 4px 16px 16px;
}

.message.ai .message-content {
  border-radius: 4px 16px 16px 16px;
}

.message-actions {
  position: absolute;
  bottom: -8px;
  right: 12px;
  display: flex;
  gap: 8px;
  opacity: 0;
  transition: opacity 0.15s ease;
}

.message:hover .message-actions {
  opacity: 1;
}

.action-btn {
  padding: 6px 8px;
  background: var(--bg-primary);
  border: 1px solid var(--border-light);
  color: var(--text-muted);
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  gap: 4px;
  box-shadow: var(--shadow-light);
}

.action-btn:hover {
  background: var(--hover-bg);
  color: var(--text-primary);
  border-color: var(--border-medium);
}

.action-btn svg {
  width: 12px;
  height: 12px;
}

/* Code blocks */
.code-block {
  background: #1a1a1a;
  border-radius: 8px;
  margin: 16px 0;
  overflow: hidden;
  border: 1px solid var(--border-light);
}

.code-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid var(--border-light);
}

.code-lang {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  font-weight: 500;
}

.copy-code-btn {
  padding: 6px 12px;
  font-size: 12px;
  background: var(--accent-primary);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.copy-code-btn:hover {
  background: var(--accent-hover);
}

.code-content {
  padding: 16px;
  font-family: 'SFMono-Regular', 'Monaco', 'Menlo', 'Consolas', monospace;
  font-size: 14px;
  line-height: 1.4;
  color: #e5e7eb;
  overflow-x: auto;
}

/* Input area */
.input-container {
  border-top: 1px solid var(--border-light);
  background: var(--bg-primary);
  padding: 24px;
}

.input-wrapper {
  max-width: 768px;
  margin: 0 auto;
  position: relative;
}

.input-area {
  display: flex;
  align-items: flex-end;
  background: var(--bg-secondary);
  border: 2px solid var(--border-light);
  border-radius: 24px;
  padding: 12px 16px;
  transition: all 0.15s ease;
}

.input-area:focus-within {
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 1px var(--accent-primary);
}

.input-field {
  flex: 1;
  background: none;
  border: none;
  outline: none;
  color: var(--text-primary);
  font-size: 16px;
  resize: none;
  max-height: 200px;
  line-height: 1.5;
  font-family: inherit;
}

.input-field::placeholder {
  color: var(--text-muted);
}

.send-btn {
  padding: 8px;
  background: var(--accent-primary);
  border: none;
  border-radius: 50%;
  cursor: pointer;
  color: white;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 8px;
}

.send-btn:hover:not(:disabled) {
  background: var(--accent-hover);
  transform: scale(1.05);
}

.send-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.send-btn svg {
  width: 16px;
  height: 16px;
}

/* Typing indicator */
.typing {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-muted);
  font-size: 14px;
}

.typing-dots {
  display: flex;
  gap: 4px;
}

.typing-dot {
  width: 6px;
  height: 6px;
  background: var(--text-muted);
  border-radius: 50%;
  animation: typing 1.5s infinite ease-in-out;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
  0%, 60%, 100% { opacity: 0.3; }
  30% { opacity: 1; }
}

/* Welcome screen */
.welcome {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  text-align: center;
  padding: 48px 24px;
}

.welcome-icon {
  width: 40px;
  height: 40px;
  background: var(--accent-primary);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 32px;
  color: white;
  font-size: 20px;
  font-weight: 600;
}

.welcome-title {
  font-size: 24px;
  font-weight: 400;
  margin-bottom: 32px;
  color: var(--text-primary);
}

.welcome-examples {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  max-width: 900px;
  width: 100%;
  margin-bottom: 32px;
}

.example-section {
  text-align: center;
}

.example-title {
  font-size: 18px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.example-title svg {
  width: 20px;
  height: 20px;
}

.example-item {
  background: var(--bg-secondary);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.15s ease;
  font-size: 14px;
  color: var(--text-secondary);
}

.example-item:hover {
  background: var(--hover-bg);
  border-color: var(--border-medium);
}

.welcome-capabilities {
  font-size: 13px;
  color: var(--text-muted);
  max-width: 600px;
  line-height: 1.4;
}
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 24px;
  color: white;
  font-size: 24px;
  font-weight: 600;
}

.welcome-title {
  font-size: 28px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text-primary);
}

.welcome-subtitle {
  font-size: 16px;
  color: var(--text-secondary);
  max-width: 500px;
  line-height: 1.5;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    transform: translateX(-100%);
    z-index: 1000;
    width: 300px;
  }
  
  .sidebar.open {
    transform: translateX(0);
  }
  
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 999;
  }
  
  .overlay.show {
    display: block;
  }
  
  .header {
    padding: 12px 16px;
  }
  
  .input-container {
    padding: 16px;
  }
  
  .chat-inner {
    padding: 16px;
  }
  
  .mobile-menu {
    display: block;
  }
}

.mobile-menu {
  display: none;
}

@media (min-width: 769px) {
  .mobile-menu {
    display: none !important;
  }
}
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <button class="new-chat-btn" onclick="newChat()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/>
      </svg>
      New chat
    </button>
  </div>
  
  <div class="chat-history" id="history"></div>
  
  <div class="sidebar-footer">
    <button class="footer-btn" onclick="clearHistory()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"/>
      </svg>
      Clear conversations
    </button>
    <button class="footer-btn" onclick="toggleTheme()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="theme-icon">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z"/>
      </svg>
      <span id="theme-text">Dark mode</span>
    </button>
  </div>
</div>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<div class="main">
  <div class="header">
    <div class="header-title">
      <button class="header-btn mobile-menu" onclick="toggleSidebar()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/>
        </svg>
      </button>
      <div class="status-dot"></div>
      Nexus AI
    </div>
    <div class="header-actions">
      <button class="header-btn" onclick="exportChat()" title="Export chat">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"/>
        </svg>
      </button>
    </div>
  </div>
  
  <div class="chat-container" id="chatContainer">
    <div class="chat-inner" id="chatInner"></div>
  </div>
  
  <div class="input-container">
    <div class="input-wrapper">
      <div class="input-area">
        <textarea 
          class="input-field" 
          id="messageInput" 
          placeholder="Message Nexus..." 
          rows="1"
        ></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Global state
let conversations = JSON.parse(localStorage.getItem('claude_conversations') || '[]');
let currentConversationId = localStorage.getItem('claude_current_id') || null;
let currentMessages = [];
let isTyping = false;

// DOM elements
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const chatInner = document.getElementById('chatInner');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const history = document.getElementById('history');

// Initialize
function init() {
  loadCurrentConversation();
  renderHistory();
  showWelcomeIfEmpty();
  loadTheme();
  
  // Auto-resize textarea
  messageInput.addEventListener('input', autoResize);
  
  // Send on Enter
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
}

function autoResize() {
  messageInput.style.height = 'auto';
  messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function showWelcomeIfEmpty() {
  if (currentMessages.length === 0) {
    chatInner.innerHTML = `
      <div class="welcome">
        <div class="welcome-icon">C</div>
        <h1 class="welcome-title">How can Nexus help you today?</h1>
        <p class="welcome-subtitle">I'm Nexus, an AI assistant. I can help with analysis, writing, math, coding, creative projects, and thoughtful conversation.</p>
      </div>
    `;
  }
}

function loadCurrentConversation() {
  if (currentConversationId) {
    const conv = conversations.find(c => c.id === currentConversationId);
    if (conv) {
      currentMessages = [...conv.messages];
      renderMessages();
    } else {
      startNewChat();
    }
  } else {
    startNewChat();
  }
}

function startNewChat() {
  if (currentMessages.length > 0) {
    saveCurrentConversation();
  }
  
  currentConversationId = generateId();
  currentMessages = [];
  localStorage.setItem('claude_current_id', currentConversationId);
  chatInner.innerHTML = '';
  showWelcomeIfEmpty();
  renderHistory();
}

function saveCurrentConversation() {
  if (currentMessages.length === 0) return;
  
  const existingIndex = conversations.findIndex(c => c.id === currentConversationId);
  const conversation = {
    id: currentConversationId,
    title: currentMessages[0]?.content.substring(0, 60) + '...' || 'New conversation',
    timestamp: Date.now(),
    messages: currentMessages
  };
  
  if (existingIndex >= 0) {
    conversations[existingIndex] = conversation;
  } else {
    conversations.unshift(conversation);
  }
  
  // Keep only last 50 conversations
  if (conversations.length > 50) {
    conversations = conversations.slice(0, 50);
  }
  
  localStorage.setItem('claude_conversations', JSON.stringify(conversations));
}

function renderHistory() {
  history.innerHTML = '';
  
  conversations.forEach(conv => {
    const item = document.createElement('div');
    item.className = 'chat-item';
    if (conv.id === currentConversationId) {
      item.classList.add('active');
    }
    
    const timeAgo = getTimeAgo(conv.timestamp);
    
    item.innerHTML = `
      <div class="chat-item-content">
        <div class="chat-item-title">${conv.title}</div>
        <div class="chat-item-date">${timeAgo}</div>
      </div>
      <button class="delete-btn" onclick="deleteConversation('${conv.id}', event)">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
        </svg>
      </button>
    `;
    
    item.onclick = () => loadConversation(conv.id);
    history.appendChild(item);
  });
}

function getTimeAgo(timestamp) {
  const now = Date.now();
  const diff = now - timestamp;
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  
  if (days === 0) return 'Today';
  if (days === 1) return 'Yesterday';
  if (days < 7) return `${days} days ago`;
  if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
  return `${Math.floor(days / 30)} months ago`;
}

function loadConversation(convId) {
  if (convId === currentConversationId) return;
  
  saveCurrentConversation();
  
  const conv = conversations.find(c => c.id === convId);
  if (conv) {
    currentConversationId = convId;
    currentMessages = [...conv.messages];
    localStorage.setItem('claude_current_id', currentConversationId);
    renderMessages();
    renderHistory();
  }
}

function deleteConversation(convId, event) {
  event.stopPropagation();
  
  if (confirm('Delete this conversation?')) {
    conversations = conversations.filter(c => c.id !== convId);
    localStorage.setItem('claude_conversations', JSON.stringify(conversations));
    
    if (convId === currentConversationId) {
      startNewChat();
    } else {
      renderHistory();
    }
  }
}

function renderMessages() {
  chatInner.innerHTML = '';
  
  if (currentMessages.length === 0) {
    showWelcomeIfEmpty();
    return;
  }
  
  currentMessages.forEach(msg => {
    addMessageToDOM(msg.content, msg.role, false);
  });
  
  scrollToBottom();
}

function addMessageToDOM(content, role, animate = true) {
  const message = document.createElement('div');
  message.className = `message ${role}`;
  if (animate) {
    message.style.opacity = '0';
    message.style.transform = 'translateY(20px)';
  }
  
  const avatar = document.createElement('div');
  avatar.className = `avatar ${role}`;
  avatar.textContent = role === 'user' ? 'U' : 'C';
  
  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';
  
  // Process content for code blocks
  const processedContent = processCodeBlocks(content);
  messageContent.innerHTML = processedContent;
  
  const messageActions = document.createElement('div');
  messageActions.className = 'message-actions';
  
  const copyBtn = document.createElement('button');
  copyBtn.className = 'action-btn';
  copyBtn.innerHTML = `
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"/>
    </svg>
    Copy
  `;
  
  copyBtn.onclick = () => copyMessage(content, copyBtn);
  messageActions.appendChild(copyBtn);
  messageContent.appendChild(messageActions);
  
  message.appendChild(avatar);
  message.appendChild(messageContent);
  chatInner.appendChild(message);
  
  if (animate) {
    requestAnimationFrame(() => {
      message.style.transition = 'all 0.3s ease';
      message.style.opacity = '1';
      message.style.transform = 'translateY(0)';
    });
  }
  
  scrollToBottom();
}

function processCodeBlocks(text) {
  // Replace code blocks with formatted HTML
  const codeRegex = /```(\w*)\n([\s\S]*?)```/g;
  let processedText = text;
  
  processedText = processedText.replace(codeRegex, (match, lang, code) => {
    return `
      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">${lang || 'code'}</span>
          <button class="copy-code-btn" onclick="copyCode(this, \`${code.replace(/`/g, '\\`')}\`)">Copy</button>
        </div>
        <div class="code-content">${escapeHtml(code)}</div>
      </div>
    `;
  });
  
  // Convert line breaks to HTML
  if (!codeRegex.test(text)) {
    processedText = processedText.replace(/\n/g, '<br>');
  }
  
  return processedText;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function copyMessage(text, button) {
  navigator.clipboard.writeText(text).then(() => {
    const originalText = button.innerHTML;
    button.innerHTML = `
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5"/>
      </svg>
      Copied!
    `;
    setTimeout(() => {
      button.innerHTML = originalText;
    }, 2000);
  });
}

function copyCode(button, code) {
  navigator.clipboard.writeText(code).then(() => {
    button.textContent = 'Copied!';
    setTimeout(() => {
      button.textContent = 'Copy';
    }, 2000);
  });
}

function showTyping() {
  const typingDiv = document.createElement('div');
  typingDiv.id = 'typing-indicator';
  typingDiv.className = 'message ai';
  
  typingDiv.innerHTML = `
    <div class="avatar ai">C</div>
    <div class="message-content">
      <div class="typing">
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
    </div>
  `;
  
  chatInner.appendChild(typingDiv);
  scrollToBottom();
}

function hideTyping() {
  const typingIndicator = document.getElementById('typing-indicator');
  if (typingIndicator) {
    typingIndicator.remove();
  }
}

function scrollToBottom() {
  const chatContainer = document.getElementById('chatContainer');
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

async function sendMessage() {
  const text = messageInput.value.trim();
  if (!text || isTyping) return;
  
  // Clear welcome screen on first message
  if (currentMessages.length === 0) {
    chatInner.innerHTML = '';
  }
  
  // Add user message
  addMessageToDOM(text, 'user');
  currentMessages.push({ role: 'user', content: text, timestamp: Date.now() });
  
  // Clear input
  messageInput.value = '';
  autoResize();
  
  // Show typing indicator
  isTyping = true;
  sendBtn.disabled = true;
  showTyping();
  
  try {
    // Simulate API call
    const response = await simulateAIResponse(text);
    
    hideTyping();
    addMessageToDOM(response, 'ai');
    currentMessages.push({ role: 'ai', content: response, timestamp: Date.now() });
    
    saveCurrentConversation();
    renderHistory();
    
  } catch (error) {
    hideTyping();
    const errorMsg = 'Sorry, I encountered an error. Please try again.';
    addMessageToDOM(errorMsg, 'ai');
    currentMessages.push({ role: 'ai', content: errorMsg, timestamp: Date.now() });
  } finally {
    isTyping = false;
    sendBtn.disabled = false;
  }
}

// Simulate AI response
async function simulateAIResponse(userMessage) {
  // Add realistic delay
  await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));
  
  const responses = [
    "I'd be happy to help you with that! Could you provide more details about what specifically you're looking for?",
    "That's an interesting question. Let me think through this step by step...\n\nFirst, we should consider the context and requirements. Then we can explore different approaches and their trade-offs.",
    "Here's a comprehensive approach to your question:\n\n1. **Analysis**: Let's break down the key components\n2. **Implementation**: I'll walk you through the steps\n3. **Best practices**: Some important considerations\n\nWould you like me to elaborate on any of these points?",
    "I understand what you're asking about. Here's a code example that might help:\n\n```python\ndef example_function(param):\n    # Process the input\n    result = param * 2\n    return result\n\n# Usage\noutput = example_function(5)\nprint(output)  # Output: 10\n```\n\nThis demonstrates the basic pattern you're looking for.",
    "That's a thoughtful question that touches on several important aspects. Let me provide a detailed response:\n\n**Key Points:**\n- The fundamental principle here is...\n- Consider the implications of...\n- Alternative approaches include...\n\nWhat specific aspect would you like me to explore further?"
  ];
  
  return responses[Math.floor(Math.random() * responses.length)];
}

function newChat() {
  startNewChat();
  if (window.innerWidth <= 768) {
    toggleSidebar();
  }
}

function clearHistory() {
  if (confirm('Delete all conversations? This action cannot be undone.')) {
    conversations = [];
    localStorage.setItem('claude_conversations', JSON.stringify(conversations));
    startNewChat();
  }
}

function toggleSidebar() {
  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
}

function exportChat() {
  if (currentMessages.length === 0) {
    alert('No messages to export');
    return;
  }
  
  const chatText = currentMessages
    .map(msg => `${msg.role.toUpperCase()}: ${msg.content}`)
    .join('\n\n');
    
  const blob = new Blob([chatText], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `claude-chat-${new Date().toISOString().split('T')[0]}.txt`;
  a.click();
  URL.revokeObjectURL(url);
}

function toggleTheme() {
  document.body.classList.toggle('dark');
  const themeText = document.getElementById('theme-text');
  const isDark = document.body.classList.contains('dark');
  
  themeText.textContent = isDark ? 'Light mode' : 'Dark mode';
  localStorage.setItem('claude_theme', isDark ? 'dark' : 'light');
  
  // Update theme icon
  const themeIcon = document.querySelector('.theme-icon');
  themeIcon.innerHTML = isDark 
    ? '<path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"/>'
    : '<path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z"/>';
}

function loadTheme() {
  const savedTheme = localStorage.getItem('claude_theme');
  const themeText = document.getElementById('theme-text');
  
  if (savedTheme === 'dark') {
    document.body.classList.add('dark');
    themeText.textContent = 'Light mode';
    
    const themeIcon = document.querySelector('.theme-icon');
    themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"/>';
  }
}

// Initialize the app
init();
</script>
</body>
</html>
